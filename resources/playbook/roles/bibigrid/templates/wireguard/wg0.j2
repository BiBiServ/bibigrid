{% set this_peer = wireguard.peers|selectattr("ip", "==", public_ip.ansible_facts.ipify_public_ip)|first %}
# Config Master node {{ this_peer.name }}
# This node's ipv4: {{ public_ip.ansible_facts.ipify_public_ip }}

[Interface]
Address = 10.0.0.{{1 if inventory_hostname in groups['master'] else groups['vpnwkrs'].index(inventory_hostname) +2}}/24
PrivateKey = {{ this_peer.private_key }}

ListenPort = 51820

# For every vpn but self
{% for peer in wireguard.peers %}
{% if peer.ip != this_peer.ip %}  # don't want to be own peer
[Peer]  # {{ peer.name }}
PublicKey = {{ peer.public_key }}
AllowedIPs = 10.0.0.0/24, {{peer.subnet}}
Endpoint = {{ peer.ip }}:51820
{% endif %}
{% endfor %}

PersistentKeepalive = 25